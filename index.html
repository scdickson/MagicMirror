<html>
	<head>
		<title>Mirror</title>
		<style>
			body {
				background-color:black; 
				font-family:"Helvetica Neue Light", "Helvetica Neue", Helvetica; 
				padding:20;
			}
			h1 {color:white; margin:0; font-size: 400%;}
			h2 {color:white; margin:0; font-size: 200%;}
			h3 {color:white; margin:0; font-size: 200%;}
			h4 {color:white; margin:0; font-size: 100%;}
			li {color:white; margin:0; padding: 2;}
			#news-scroll {position:absolute; bottom:20; left:0; display:block;}
			#calendar {color:white;}
			#weather_icon {font-size: 400%}
			#greeting {
				width: 500px;
			    height: 100px;
			    background-color: black;
			    text-align: center;

			    position: absolute;
			    top:0;
			    bottom: 0;
			    left: 0;
			    right: 0;

			    margin: auto;
			}
			ul.event{
				list-style-image: url('images/event_icon.png');
			}
		</style>

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
		<script src="http://kincrew.github.com/xReader/xReader.full.js"></script>
		<script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
		<script src="js/marquee.js"></script>
		<script src="js/phrases.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="css/weather-icons.css"></link>

		<script>
			var GREETING_TICK_MINS = 20;

			var WEATHER_CITY = "Mountain View, US";
			var WEATHER_UNITS = "imperial";
			var OPEN_WEATHER_API_KEY = "69af76d71dc68e78a68d0171f1269551";
			var WEATHER_REFRESH_MINS = 15;
			var WEATHER_ICON_TABLE = {
				'01d':'wi-day-sunny',
				'02d':'wi-day-cloudy',
				'03d':'wi-cloudy',
				'04d':'wi-cloudy-windy',
				'09d':'wi-showers',
				'10d':'wi-rain',
				'11d':'wi-thunderstorm',
				'13d':'wi-snow',
				'50d':'wi-fog',
				'01n':'wi-night-clear',
				'02n':'wi-night-cloudy',
				'03n':'wi-night-cloudy',
				'04n':'wi-night-cloudy',
				'09n':'wi-night-showers',
				'10n':'wi-night-rain',
				'11n':'wi-night-thunderstorm',
				'13n':'wi-night-snow',
				'50n':'wi-night-alt-cloudy-windy'
			};
			var DAYS_LIST = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

			var NEWS_RSS_USL = "http://feeds.reuters.com/reuters/topNews";
			var NEWS_REFRESH_MINS = 60;

			var GOOGLE_API_PUBLIC_KEY = "AIzaSyDrYX6fS5dnlZ_ISX5f49MvKF45lpfNfZ0";
			var GOOGLE_CALENDAR_ID = "dicksoncs@gmail.com";
			var GOOGLE_CALENDAR_REFRESH_MINS = 30;
			var GOOGLE_CALENDAR_MAX_EVENTS = 5;

			var GOOGLE_MAPS_ORIGIN = "777 W Middlefield Rd, Mountain View, CA 94043";
			var GOOGLE_MAPS_DESTINATION = "930 Deguigne Dr, Sunnyvale, CA";
			var GOOGLE_MAPS_REFRESH_MINS = 15;

			var CALTRAIN_STATION_NAME = "mountainview";
			var CALTRAIN_DEPARTURE_REFRESH_MINS = 5;

			var TWITCH_GAME = "Dota 2";
			var TWITCH_CHANNEL_LIMIT = 8;
			var TWITCH_REFRESH_MINS = 20;

			function loadData()
			{
				startTime();
				getWeather();
				getNews();
				getCalendar();
				getTravelTime();
				getLiveTwitchStreams();
				getCaltrainDepartures();
				//setupFirebase();
			}

			function setupFirebase()
			{
				var personWatcher = new Firebase('https://glowing-heat-3874.firebaseio.com/');
				personWatcher.on('child_changed', function(snapshot)
				{
					var data = snapshot.val();
					if(data.num > 0)
					{
						showGreeting();
					}
				});
			}

			function showGreeting()
			{
					var el = document.getElementById("greeting");
					$(el).fadeOut('slow', function()
					{
						document.getElementById('greeting').innerHTML = getPhrase();
	        			$(el).fadeIn(2000, function()
	        			{
	        				setTimeout(function(){
	        					$(el).fadeOut(3000);
	        				}, 2000);
	        			});
	    			});
			}

			function getLiveTwitchStreams()
			{
				TWITCH_GAME = TWITCH_GAME.replace(/ /g, "+");
				xReader("https://api.twitch.tv/kraken/streams?game=" + TWITCH_GAME + "&limit=" + TWITCH_CHANNEL_LIMIT, function(data) 
				{ 
				    parseLiveTwitchStreams(data); 
				})

				var t = setTimeout(getLiveTwitchStreams, TWITCH_REFRESH_MINS * 60 * 1000);	
			}

			function parseLiveTwitchStreams(data)
			{
				var channel_list = "<table style=\"color:white;\">";
				xml = $.parseXML(data.content);
				$(xml).find("streams").each(function() 
				{
					var channel_name = $(this).find("channel").find("display_name").text();
					var channel_img = $(this).find("channel").find("logo").text()
					
					channel_list += "<tr><td><img src=\"" + channel_img + "\" width=\"25\" height=\"25\"/></td><td>&nbsp;&nbsp;&nbsp;</td><td>" + channel_name + "</td></tr>";
				});
				channel_list += "</table>";
				document.getElementById('twitch').innerHTML = channel_list;
			}

			function startTime() 
			{
			    var today = new Date();
			    document.getElementById('date').innerHTML = today.toDateString();
			    var h = today.getHours();
			    var m = today.getMinutes();
			    var s = today.getSeconds();
			    h = checkTime(h);
			    m = checkTime(m);
			    s = checkTime(s);
			    document.getElementById('time').innerHTML =
			    h + ":" + m + ":" + s;

			    var t = setTimeout(startTime, 500);
			}

			function checkTime(i) 
			{
			    if (i < 10) {i = "0" + i}; 
			    return i;
			}

			function getCaltrainDepartures()
			{
				xReader("http://www.caltrain.com/stations/" + CALTRAIN_STATION_NAME + "station.html", function(data) 
				{ 
				    parseCaltrainDepartures(data); 
				})

				var t = setTimeout(getCaltrainDepartures, CALTRAIN_DEPARTURE_REFRESH_MINS * 60 * 1000);	
			}

			function parseCaltrainDepartures(data)
			{
				var timetable_rows = data.content.split("\n");
				var i = 0;
				for(i = 0; i < timetable_rows.length; i++)
				{
					if(timetable_rows[i].indexOf("Northbound Weekdays") > 0)
					{
						i++;
						break;
					}
				}

				var temp = timetable_rows[i].split(",");
				var northbound_train_times = [];
				var nbtt_index = 0;
				var southbound_train_times = [];
				var sbtt_index = 0;

				i = 0;
				for(i = 0; i < temp.length; i++)
				{
					temp[i] = stripAlpha(temp[i]);
					if(temp[i] != '')
					{
						northbound_train_times[nbtt_index] = temp[i];
						nbtt_index++;
					}
				}

				i = 0;
				for(i = 0; i < timetable_rows.length; i++)
				{
					if(timetable_rows[i].indexOf("Southbound Weekdays") > 0)
					{
						i++;
						break;
					}
				}

				temp = timetable_rows[i].split(",");
				i = 0;
				for(i = 0; i < temp.length; i++)
				{
					temp[i] = stripAlpha(temp[i]);
					if(temp[i] != '')
					{
						southbound_train_times[sbtt_index] = temp[i];
						sbtt_index++;
					}
				}

				getNextCaltrainsFromNow(northbound_train_times, southbound_train_times);
				
			}

			function getNextCaltrainsFromNow(n_trains, s_trains)
			{
				var time_pm = false;
				var today = new Date();
				var hours = today.getHours();
				var minutes = today.getMinutes();

				var prev_hours = parseInt(n_trains[0].substring(0, n_trains[0].indexOf(":")));
				for(var i = 0; i < n_trains.length; i++)
				{
					var schedule_hours = parseInt(n_trains[i].substring(0, n_trains[i].indexOf(":")));
					var schedule_minutes = parseInt(n_trains[i].substring(n_trains[i].indexOf(":")+1));

					if(schedule_hours < prev_hours)
					{
						time_pm = !time_pm;
					}

					if(schedule_hours == 12)
					{
						if(i < n_trains.length - 1)
						{
							var nextHours = parseInt(n_trains[i+1].substring(0, n_trains[i+1].indexOf(":")));
							if(nextHours < 12)
							{
								time_pm = true;
							}
							else
							{
								time_pm = false;
							}
						}
						else
						{
							if(12 < prev_hours)
							{
								time_pm = false;
							}
						}
					}

					prev_hours = schedule_hours;

					if(time_pm)
					{
						if(schedule_hours < 12)
						{
							schedule_hours += 12;
						}

						console.log(schedule_hours + ":" + schedule_minutes + " PM");
					}
					else
					{
						if(schedule_hours == 12)
						{
							schedule_hours = 0;
						}

						console.log(schedule_hours + ":" + schedule_minutes + " AM");
					}
				}

				TIME_PM = false;
			}

			function stripAlpha(string)
			{
				var stripped = "";
				var reg = new RegExp('^[0-9:]+$');
				for(var i = 0; i < string.length; i++)
				{
					if(reg.test(string[i]))
					{
						stripped += string[i];
					}
				}
				return stripped;
			}

			function getWeather()
			{
				WEATHER_CITY = WEATHER_CITY.replace(/ /g, "+");
				xReader("http://api.openweathermap.org/data/2.5/weather?q=" + WEATHER_CITY + "&appid=" + OPEN_WEATHER_API_KEY + "&units=" + WEATHER_UNITS, function(data) 
				{ 
				    parseCurrentWeather(data); 
				})	

				xReader("http://api.openweathermap.org/data/2.5/forecast/daily?q=" + WEATHER_CITY + "&appid=" + OPEN_WEATHER_API_KEY + "&units=" + WEATHER_UNITS, function(data) 
				{ 
				    parseForecastWeather(data); 
				})	

				var t = setTimeout(getWeather, WEATHER_REFRESH_MINS * 60 * 1000);
			}

			function parseCurrentWeather(data)
			{
				xml = $.parseXML(data.content);
				var current_temp = Math.round($(xml).find("main").find("temp").text()) + "\u00B0";
				var current_icon = $(xml).find("weather").find("icon").text();

				document.getElementById('current_weather').innerHTML = current_temp;
				document.getElementById("weather_icon").className = "wi " + WEATHER_ICON_TABLE[current_icon];
			}

			function parseForecastWeather(data)
			{
				var forecast_table = "<table style=\"color:white;\">";
				xml = $.parseXML(data.content);
				var i = 0;
				var now = new Date();
				var current_day = now.getDay();
				var weather_icon_array = [];

				$(xml).find("list").find("weather").each(function() 
				{
					weather_icon_array[i++] = $(this).find("icon").text();
				});

				i = 0;
				$(xml).find("list").find("temp").each(function() 
				{
					if(i > 0)
					{
						current_day = getNextDay(current_day);

						forecast_table += "<tr><td>" + DAYS_LIST[current_day] + "&nbsp;&nbsp;</td><td>" + "<i class=\"wi " + WEATHER_ICON_TABLE[weather_icon_array[i]] + "\"></i>&nbsp;&nbsp;</td><td>" + Math.round($(this).find("min").text()) + "\u00B0</td><td>|&nbsp;&nbsp;" + Math.round($(this).find("max").text()) + "\u00B0</td></tr>";
					}

					i++;
				});

				forecast_table += "</table>";
				document.getElementById('forecast').innerHTML = forecast_table;
			}

			function getNextDay(dayNum)
			{
				if(dayNum == 6)
				{
					return 0;
				}

				return dayNum + 1;
			}

			function getNews()
			{
				xReader(NEWS_RSS_USL, function(data) 
				{ 
				    parseNews(data.content.split("<title>")); 
				})	

				var t = setTimeout(getNews, NEWS_REFRESH_MINS * 60 * 1000);
			}

			function parseNews(data)
			{
				var news = "";
				for(i = 3; i < data.length; i++)
				{
					news += data[i].substring(0, data[i].indexOf("</title>")) + "&nbsp;\u2022&nbsp;";
				}
				document.getElementById('news-content').innerHTML = news;
			}

			function getCalendar()
			{
				var now = new Date();
				var calendar_url = "https://www.googleapis.com/calendar/v3/calendars/" + GOOGLE_CALENDAR_ID + "/events?key=" + GOOGLE_API_PUBLIC_KEY + "&timeMin=" + ISODateString(now);
				xReader(calendar_url, function(data) 
				{ 
				    parseCalendar(data); 
				})	

				var t = setTimeout(getCalendar, GOOGLE_CALENDAR_REFRESH_MINS * 60 * 1000);
			}

			function ISODateString(d)
			{
				 function pad(n){return n<10 ? '0'+n : n}
				 return d.getUTCFullYear()+'-'
				      + pad(d.getUTCMonth()+1)+'-'
				      + pad(d.getUTCDate())+'T'
				      + pad(d.getUTCHours())+':'
				      + pad(d.getUTCMinutes())+':'
				      + pad(d.getUTCSeconds())+'Z'
			}

			function parseCalendar(data)
			{
				var event_string = "<ul class=\"event\">";
				var events = []
				xml = $.parseXML(data.content);
				var datetime_options = {
				    weekday: "short", month: "short",
				    day: "numeric", hour: "2-digit", minute: "2-digit"
				};
				var date_options = {
				    weekday: "short", month: "short", day: "numeric"
				};

				var i = 0;
				$(xml).find("items").each(function() 
				{
					showTime = true;
					var start = $(this).find("start").find("dateTime").text();
					if(!start)
					{
						showTime = false;
						start = $(this).find("start").find("date").text();
					}
					var event_date = new Date(start);
					var title = $(this).find("summary").text();
					var eventLine = event_date.toLocaleTimeString("en-us", datetime_options);

					if(!showTime)
					{
						eventLine = event_date.toLocaleDateString("en-us", date_options);
					}

				    events[i++] = "<li>" + eventLine + " -- " + title + "</li>"; 
				});

				var current_num_events = 0;
				for(i = events.length; i >= 0; i--)
				{
					if(events[i] && current_num_events <= GOOGLE_CALENDAR_MAX_EVENTS)
					{
						event_string += events[i];
						current_num_events += 1;
					}
				}

				events += "</ul>"; 
				document.getElementById('calendar').innerHTML = event_string;
			}

			function getTravelTime()
			{
				GOOGLE_MAPS_ORIGIN = GOOGLE_MAPS_ORIGIN.replace(/ /g, "+");
				GOOGLE_MAPS_DESTINATION = GOOGLE_MAPS_DESTINATION.replace(/ /g, "+");
				var unix_epoch_time = (new Date).getTime();
				var directions_url = "https://maps.googleapis.com/maps/api/directions/json?origin=" + GOOGLE_MAPS_ORIGIN + "&destination=" + GOOGLE_MAPS_DESTINATION + "&departure_time=" + unix_epoch_time + "&key=" + GOOGLE_API_PUBLIC_KEY;
				xReader(directions_url, function(data) 
				{ 
				    parseTravelTime(data); 
				})	

				var t = setTimeout(getTravelTime, GOOGLE_MAPS_REFRESH_MINS * 60 * 1000);
			}

			function parseTravelTime(data)
			{
				xml = $.parseXML(data.content);
				travel_time = ($(xml).find("routes").find("legs").find("duration_in_traffic").find("text").text());
				document.getElementById('travel_time').innerHTML = "Estimated Travel Time: " + travel_time;
			}

			function checkSteamStatus()
			{
				
			}
		</script>
	</head>

	<body onload="loadData()">
		<div id="datetime" style="float: left;">
			<h3><div id="date"></div></h3>
			<h1><div id="time"></div></h1>
			<h4><div id="travel_time"></div></h4>
			</br>
			<div id="calendar"></div>
		</div>
		<div id="weather" style="float: right;">
			<table border="0">
				<tr>
					<td><i id="weather_icon"></i></td>
					<td>&nbsp;&nbsp;&nbsp;</td>
					<td><h1><div id="current_weather"></div></h1></td>
				</tr>
			</table>
			<hr>
			<div id="forecast"></div>
			</br></br></br>
			<img src="images/twitch_logo.png" width="200" height="69"/>
			<hr>
			<div id="twitch"></div>
		</div>
		<h2><div id="greeting"></div></h2>
		<div id="news-scroll" align="center">
			<marquee behavior="scroll" scrollamount="7" direction="left" width="1920"><h3><div id="news-content"></div></h3></marquee>
		</div>
	</body>
</html>